services:

  db:
    extends:
      file: '../localhost/docker-compose.yaml'
      service: 'db'

  api:
    depends_on:
      db:
        condition: 'service_healthy'
    extends:
      file: '../localhost/docker-compose.yaml'
      service: 'api'
    volumes:
      - ./api.yaml:/api.yaml

  cypress:
    image: cypress/included:12.2.0
    depends_on:
      api:
        condition: 'service_healthy'
      db:
        condition: 'service_healthy'
    working_dir: /workspaces/zitadel/tests/functional-ui
    user: '$UID'
    volumes:
      - ../../:/workspaces/zitadel/tests/functional-ui
    environment:
      CYPRESS_BASE_URL: http://host.docker.internal:8080/ui/console
      CYPRESS_WEBHOOK_HANDLER_HOST: host.docker.internal
      CYPRESS_DATABASE_CONNECTION_URL: 'postgresql://root@db:26257/zitadel'
    ports:
      - "8900:8900"
    extra_hosts:
    - "host.docker.internal:host-gateway"
