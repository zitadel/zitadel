{
  "$schema": "../../node_modules/nx/schemas/project-schema.json",
  "targets": {
    "test-setup": {
        "description": "Sets up the functional UI (Console) test environment by starting a local Postgres database and configuring the Zitadel API",
        "dependsOn": [
            "test-state",
            "test-build",
            "@zitadel/api:build"
        ],
        "executor": "nx:run-commands",
        "options": {
            "env": {
                "API_CONFIG_FILE": "{projectRoot}/api.yaml"
            },
            "parallel": false,
            "commands": [
                "nx run @zitadel/devcontainer:compose up --detach --force-recreate --renew-anon-volumes db-functional-ui",
                "nx run @zitadel/api:setup --excludeTaskDependencies"
            ]
        }  
    },
    "test-env": {
        "description": "Runs the Zitadel API for functional UI (Console) tests",
        "continuous": true,
        "dependsOn": [
            "test-setup"
        ],
        "options": {
            "env": {
                "API_CONFIG_FILE": "{projectRoot}/api.yaml"
            }
        },
        "command": "nx run @zitadel/api:prod --excludeTaskDependencies"
    },
    "open": {
      "description": "Opens the Cypress Test Runner for interactive testing.",
      "continuous": true,
      "dependsOn": [
        "@zitadel/console:dev",
        "test-env"
      ]
    },
    "test": {
      "description": "Runs the functional UI (Console) tests against a Zitadel API and a specified browser. Valid browsers are 'electron', 'chrome' and 'firefox'. Beware that 'chrome' and 'firefox' are not installed in the dev container.",
      "dependsOn": [
        "test-env"
      ],
      "executor": "nx:run-commands",
      "options": {
        "parallel": false,
        "cwd": "{projectRoot}",
        "forwardAllArgs": false,
        "commands": [
          "pnpm cypress install",
          "DISPLAY='' pnpm cypress run --browser {args.browser} --reporter-options reportDir=cypress/results/{args.browser} --config videosFolder=cypress/videos/{args.browser},screenshotsFolder=cypress/screenshots/{args.browser}",
          "nx run @zitadel/devcontainer:compose down db-functional-ui"
        ]
      },
      "cache": true,
      "inputs": [
        "default"
      ]
    }
  }
}
