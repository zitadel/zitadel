syntax = "proto3";

import "zitadel/idp.proto";
import "zitadel/user.proto";
import "zitadel/object.proto";
import "zitadel/options.proto";
import "zitadel/org.proto";
import "zitadel/policy.proto";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";

import "protoc-gen-openapiv2/options/annotations.proto";

import "validate/validate.proto";

package zitadel.v1;

option go_package ="github.com/caos/zitadel/pkg/grpc/admin";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
    info: {
        title: "admin service";
        version: "1.0";
        contact:{
            url: "https://github.com/caos/zitadel/api/admin" //TODO: should be swagger path
        };
    };

    schemes: HTTPS;

    consumes: "application/json";
    consumes: "application/grpc";

    produces: "application/json";
    produces: "application/grpc";
};


service AdminService {
    rpc IsOrgUnique(IsOrgUniqueRequest) returns (IsOrgUniqueResponse) {
        option (google.api.http) = {
            get: "/orgs/_isunique"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.read"
        };
    }

    rpc GetOrgByID(GetOrgByIDRequest) returns (GetOrgByIDResponse) {
        option (google.api.http) = {
            get: "/orgs/{id}"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.read"
        };
    }

    rpc ListOrgs(ListOrgsRequest) returns (ListOrgsResponse) {
        option (google.api.http) = {
            post: "/orgs/_search"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.read"
        };
    }

    rpc SetUpOrg(SetUpOrgRequest) returns (SetUpOrgResponse) {
        option (google.api.http) = {
            post: "/orgs/_setup"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.write"
        };
    }

    rpc GetIDPByID(GetIDPByIDRequest) returns (GetIDPByIDResponse) {
        option (google.api.http) = {
            get: "/idps/{id}"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.idp.read"
        };
    }

    rpc ListIDPs(ListIDPsRequest) returns (ListIDPsResponse) {
        option (google.api.http) = {
            post: "/idps/_search"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.idp.read"
        };
    }

    rpc CreateIDP(CreateIDPRequest) returns (CreateIDPResponse) {
        option (google.api.http) = {
            post: "/idps"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.idp.write"
        };
    }

    rpc DeactivateIDP(DeactivateIDPRequest) returns (DeactivateIDPResponse) {
        option (google.api.http) = {
            put: "/idps/{id}/_deactivate"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.idp.write"
        };
    }

    rpc ReactivateIDP(ReactivateIDPRequest) returns (ReactivateIDPResponse) {
        option (google.api.http) = {
            put: "/idps/{id}/_reactivate"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.idp.write"
        };
    }

    rpc RemoveIDP(RemoveIDPRequest) returns (RemoveIDPResponse) {
        option (google.api.http) = {
            delete: "/idps/{id}"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.idp.write"
        };
    }

    rpc UpdateIDP(UpdateIDPRequest) returns (UpdateIDPResponse) {
        option (google.api.http) = {
            put: "/idps/{id}"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.idp.write"
        };
    }

    rpc UpdateIDPOIDCConfig(UpdateIDPOIDCConfigRequest) returns (UpdateIDPOIDCConfigResponse) {
        option (google.api.http) = {
            put: "/idps/{idp_id}/oidcconfig"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.idp.write"
        };
    }

    rpc GetDefaultOrgIAMPolicy(GetDefaultOrgIAMPolicyRequest) returns (GetDefaultOrgIAMPolicyResponse) {
        option (google.api.http) = {
            get: "/orgs/default/policies/orgiam"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.read"
        };
    }

    rpc UpdateDefaultOrgIAMPolicy(UpdateDefaultOrgIAMPolicyRequest) returns (UpdateDefaultOrgIAMPolicyResponse) {
        option (google.api.http) = {
            put: "/orgs/default/policies/orgiam"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.write"
        };
    }

    rpc GetDefaultLabelPolicy(GetDefaultLabelPolicyRequest) returns (GetDefaultLabelPolicyResponse) {
        option (google.api.http) = {
            get: "/orgs/default/policies/label"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.read"
        };
    }

    rpc UpdateDefaultLabelPolicy(UpdateDefaultLabelPolicyRequest) returns (UpdateDefaultLabelPolicyResponse) {
        option (google.api.http) = {
            put: "/orgs/default/policies/label"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.write"
        };
    }

    rpc GetDefaultMailTemplatePolicy(GetDefaultMailTemplatePolicyRequest) returns (GetDefaultMailTemplatePolicyResponse) {
        option (google.api.http) = {
            get: "/policies/mailtemplate"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.read"
        };
    }

    rpc UpdateDefaultMailTemplate(UpdateDefaultMailTemplatePolicyRequest) returns (UpdateDefaultMailTemplatePolicyResponse) {
        option (google.api.http) = {
            put: "/policies/mailtemplate"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.write"
        };
    }

    rpc GetDefaultLoginPolicy(GetDefaultLoginPolicyRequest) returns (GetDefaultLoginPolicyResponse) {
        option (google.api.http) = {
            get: "/orgs/default/policies/login"
        };
    
        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.read"
        };
    }
    
    rpc UpdateDefaultLoginPolicy(UpdateDefaultLoginPolicyRequest) returns (UpdateDefaultLoginPolicyResponse) {
        option (google.api.http) = {
            put: "/orgs/default/policies/login"
            body: "*"
        };
    
        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.write"
        };
    }

    //TODO: imo we can just return an zitadel.idp.v1.IDP 
    // it was IDPProvider bevore but i think identity provider provider is redundant
    rpc ListDefaultLoginPolicyIDPs(ListDefaultLoginPolicyIDPsRequest) returns (ListDefaultLoginPolicyIDPsResponse) {
        option (google.api.http) = {
            post: "/policies/login/idpproviders/_search"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.read"
        };
    }

    //TODO: add is IMO configure a new one
    // if we want to link an existing IDP to the policy we should also name it LinkIDP
    rpc AddDefaultLoginPolicyIDP(AddDefaultLoginPolicyIDPRequest) returns (AddDefaultLoginPolicyIDPResponse) {
        option (google.api.http) = {
            post: "/policies/login/idpproviders"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.write"
        };
    }

    //TODO: remove is IMO not optimal because it could also be removed
    // unlink might be better
    rpc RemoveDefaultLoginPolicyIDP(RemoveDefaultLoginPolicyIDPRequest) returns (RemoveDefaultLoginPolicyIDPResponse) {
        option (google.api.http) = {
            delete: "/policies/login/idpproviders/{idp_config_id}"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.write"
        };
    }

    rpc GetDefaultPasswordComplexityPolicy(GetDefaultPasswordComplexityPolicyRequest) returns (GetDefaultPasswordComplexityPolicyResponse) {
        option (google.api.http) = {
            get: "/policies/password/complexity"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.read"
        };
    }

    rpc UpdateDefaultPasswordComplexityPolicy(UpdateDefaultPasswordComplexityPolicyRequest) returns (UpdateDefaultPasswordComplexityPolicyResponse) {
        option (google.api.http) = {
            put: "/policies/password/complexity"
            body: "*"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.write"
        };
    }

    rpc GetDefaultPasswordAgePolicy(GetDefaultPasswordAgePolicyRequest) returns (GetDefaultPasswordAgePolicyResponse) {
        option (google.api.http) = {
            get: "/policies/password/age"
        };
    
        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.read"
        };
    }
    
    rpc UpdateDefaultPasswordAgePolicy(UpdateDefaultPasswordAgePolicyRequest) returns (UpdateDefaultPasswordAgePolicyResponse) {
        option (google.api.http) = {
            put: "/policies/password/age"
            body: "*"
        };
    
        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.write"
        };
    }

    rpc GetDefaultPasswordLockoutPolicy(GetDefaultPasswordLockoutPolicyRequest) returns (GetDefaultPasswordLockoutPolicyResponse) {
        option (google.api.http) = {
            get: "/policies/password/lockout"
        };
    
        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.read"
        };
    }
    
    rpc UpdateDefaultPasswordLockoutPolicy(UpdateDefaultPasswordLockoutPolicyRequest) returns (UpdateDefaultPasswordLockoutPolicyResponse) {
        option (google.api.http) = {
            put: "/policies/password/lockout"
            body: "*"
        };
    
        option (zitadel.v1.auth_option) = {
            permission: "iam.policy.write"
        };
    }

    








    rpc ListViews(ListViewsRequest) returns (ListViewsResponse) {
        option (google.api.http) = {
            get: "/views"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.read"
        };
    }

    rpc ClearView(ClearViewRequest) returns (ClearViewResponse) {
        option (google.api.http) = {
            post: "/views/{database}/{view_name}"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.write"
        };
    }

    rpc ListFailedEvents(ListFailedEventsRequest) returns (ListFailedEventsResponse) {
        option (google.api.http) = {
            get: "/failedevents"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.read"
        };
    }

    rpc RemoveFailedEvent(RemoveFailedEventRequest) returns (RemoveFailedEventResponse) {
        option (google.api.http) = {
            delete: "/failedevents/{database}/{view_name}/{failed_sequence}"
        };

        option (zitadel.v1.auth_option) = {
            permission: "iam.write"
        };
    }
}

message IsOrgUniqueRequest {
    string name = 1 [(validate.rules).string.min_len = 1];
    string domain = 2 [(validate.rules).string.min_len = 1];
}

message IsOrgUniqueResponse {
    bool is_unique = 1;
}

message GetOrgByIDRequest {
    string id = 1;
}

message GetOrgByIDResponse {
    zitadel.v1.MetaData meta_data = 1;
    zitadel.org.v1.Org org = 2;
}

message ListOrgsRequest {
    zitadel.v1.Search meta_data = 1;
    zitadel.org.v1.OrgFieldName sorting_column = 2;
    repeated zitadel.org.v1.OrgQuery queries = 3;
}

message ListOrgsResponse {
    zitadel.v1.Search meta_data = 1;
    zitadel.org.v1.OrgFieldName sorting_column = 2;
    repeated zitadel.org.v1.Org result = 3;
}

message SetUpOrgRequest {
    zitadel.org.v1.Org org = 1;
    zitadel.user.v1.User user = 2;
}

message SetUpOrgResponse {
    zitadel.v1.MetaData meta_data = 1;
    zitadel.org.v1.Org org = 2;
    zitadel.user.v1.User user = 3;
}

message GetIDPByIDRequest {
    string id = 1;
}

message GetIDPByIDResponse {
    zitadel.v1.MetaData meta_data = 1;
    zitadel.idp.v1.IDP idp = 2;
}

message ListIDPsRequest {
    zitadel.v1.Search meta_data = 1;
    zitadel.idp.v1.IDPFieldName sorting_column = 2;
    repeated zitadel.idp.v1.IDPQuery queries = 3;
}

message ListIDPsResponse {
    zitadel.v1.Search meta_data = 1;
    zitadel.idp.v1.IDPFieldName sorting_column = 2;
    repeated zitadel.idp.v1.IDP result = 3;
}

message CreateIDPRequest {
    message OIDCConfig {
        string issuer = 1;
        repeated string scopes = 2;
        zitadel.idp.v1.OIDCMappingField idp_display_name_mapping = 3;
        zitadel.idp.v1.OIDCMappingField username_mapping = 4;
    }

    string name = 1;
    zitadel.idp.v1.IDPStylingType styling_type = 2;
    oneof config {
        OIDCConfig oidc_config = 3;
    }
}

message CreateIDPResponse {
    message OIDCConfig {
        string client_id = 1;
        string client_secret = 2;
    }

    string id = 1;
    zitadel.v1.MetaData meta_data = 2;
    oneof config {
        OIDCConfig oidc_config = 3;
    }
}

message DeactivateIDPRequest {
    string id = 1;
}

message DeactivateIDPResponse {
    zitadel.v1.MetaData meta_data = 1;
}

message ReactivateIDPRequest {
    string id = 1;
}

message ReactivateIDPResponse {
    zitadel.v1.MetaData meta_data = 1;
}

message RemoveIDPRequest {
    string id = 1;
}

message RemoveIDPResponse {
    zitadel.v1.MetaData meta_data = 1;
}

message UpdateIDPRequest {
    string id = 1;
    string name = 2;
    zitadel.idp.v1.IDPStylingType styling_type = 3;
}

message UpdateIDPResponse {
    string id = 1;
    zitadel.v1.MetaData meta_data = 2;
}

message UpdateIDPOIDCConfigRequest {
    string idp_id = 1;
    string issuer = 2;
    repeated string scopes = 3;
    zitadel.idp.v1.OIDCMappingField idp_display_name_mapping = 4;
    zitadel.idp.v1.OIDCMappingField username_mapping = 5;
}

message UpdateIDPOIDCConfigResponse {
    string idp_id = 1;
    zitadel.v1.MetaData meta_data = 2;
}

message GetDefaultOrgIAMPolicyRequest {}

message GetDefaultOrgIAMPolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
    zitadel.policy.v1.OrgIAMPolicy policy = 2;
}

message UpdateDefaultOrgIAMPolicyRequest {
    string description = 1;
    bool user_login_must_be_domain = 2;
}

message UpdateDefaultOrgIAMPolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
    //TODO: do policies have an id?
}

message GetDefaultLabelPolicyRequest {}

message GetDefaultLabelPolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
    zitadel.policy.v1.LabelPolicy policy = 2;
}

message UpdateDefaultLabelPolicyRequest {
    string primary_color = 1;
    string secondary_color = 2;
}

message UpdateDefaultLabelPolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
}

message GetDefaultMailTemplatePolicyRequest {}

message GetDefaultMailTemplatePolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
    zitadel.policy.v1.MailTemplatePolicy policy = 2;
}

message UpdateDefaultMailTemplatePolicyRequest {
    string mail_text_type = 1; //TODO: type sounds like an enum
	string language = 2; //TODO: enum?
	string title = 3;
	string pre_header = 4;
	string subject = 5;
	string greeting = 6;
	string text = 7;
	string button_text = 8;
}

message UpdateDefaultMailTemplatePolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
}

message GetDefaultLoginPolicyRequest {}

message GetDefaultLoginPolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
    zitadel.policy.v1.LoginPolicy policy = 2;
}

message UpdateDefaultLoginPolicyRequest {
    bool allow_username_password = 1;
    bool allow_register = 2;
    bool allow_external_idp = 3;
    bool force_mfa = 4;
    zitadel.policy.v1.PasswordlessType passwordless_type = 5;
}

message UpdateDefaultLoginPolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
    //TODO: do policies have an id?
}

message ListDefaultLoginPolicyIDPsRequest {}

message ListDefaultLoginPolicyIDPsResponse {}

message AddDefaultLoginPolicyIDPRequest {}

message AddDefaultLoginPolicyIDPResponse {}

message RemoveDefaultLoginPolicyIDPRequest {}

message RemoveDefaultLoginPolicyIDPResponse {}


message GetDefaultPasswordComplexityPolicyRequest {}

message GetDefaultPasswordComplexityPolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
    zitadel.policy.v1.PasswordComplexityPolicy policy = 2;
}


message UpdateDefaultPasswordComplexityPolicyRequest {
    uint32 min_length = 1;
    bool has_uppercase = 2;
    bool has_lowercase = 3;
    bool has_number = 4;
    bool has_symbol = 5;
}

message UpdateDefaultPasswordComplexityPolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
}

message GetDefaultPasswordAgePolicyRequest {}

message GetDefaultPasswordAgePolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
    zitadel.policy.v1.PasswordAgePolicy policy = 2;
}


message UpdateDefaultPasswordAgePolicyRequest {
    uint64 max_age_days = 1;
    uint64 expire_warn_days = 2;
}

message UpdateDefaultPasswordAgePolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
}

message GetDefaultPasswordLockoutPolicyRequest {}

message GetDefaultPasswordLockoutPolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
    zitadel.policy.v1.PasswordLockoutPolicy policy = 2;
}


message UpdateDefaultPasswordLockoutPolicyRequest {
    uint64 max_attempts = 1;
    bool show_lockout_failure = 2;
}

message UpdateDefaultPasswordLockoutPolicyResponse {
    zitadel.v1.MetaData meta_data = 1;
}














message ListViewsRequest {}

message ListViewsResponse {
    repeated View views = 1;
}

message ClearViewRequest {
    string database = 1 [(validate.rules).string = {min_len: 1}];
    string view_name = 2 [(validate.rules).string = {min_len: 1}];
}

message ClearViewResponse {}

message ListFailedEventsRequest {}

message ListFailedEventsResponse {
    repeated FailedEvent result = 1;
}

message RemoveFailedEventRequest {
    string database = 1 [(validate.rules).string = {min_len: 1}];
    string view_name = 2 [(validate.rules).string = {min_len: 1}];
    uint64 failed_sequence = 3;
}

message RemoveFailedEventResponse {}

message View {
    string database = 1;
    string view_name = 2;
    uint64 processed_sequence = 3;
    google.protobuf.Timestamp event_timestamp = 4;
    google.protobuf.Timestamp last_successful_spooler_run = 5;
}

message FailedEvent {
    string database = 1;
    string view_name = 2;
    uint64 failed_sequence = 3;
    uint64 failure_count = 4;
    string error_message = 5;
}