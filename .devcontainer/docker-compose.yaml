services:

  devcontainer:
    container_name: devcontainer
    build:
      context: .
    volumes:
      - ../:/workspaces/zitadel:cached
    command: sleep infinity
    working_dir: /workspaces/zitadel
    environment:
      DEVCONTAINER_DB_HOST: db
      DEVCONTAINER_API_HOST: api
      DEVCONTAINER_LOGIN_HOST: login
      DEVCONTAINER_LOGIN_API_MOCK_HOST: login-api-mock
      DEVCONTAINER_DB_API_INTEGRATION_HOST: db-api-integration
      DEVCONTAINER_DB_FUNCTIONAL_UI_HOST: db-functional-ui
    ports:
      - "8080:8080"
      - "3000:3000"
      - "4200:4200"

  db:
    container_name: db
    image: postgres:17
    restart: unless-stopped
    env_file:
      - ./.env.db
    volumes:
      - db-data-dev:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready", "-U", "postgres" ]
      interval: "10s"
      timeout: "30s"
      retries: 5
      start_period: "20s"
    ports:
      - 5432:5432

  db-api-integration:
    restart: 'always'
    image: 'postgres:17'
    env_file:
      - ./.env.db
    command: postgres -c shared_preload_libraries=pg_stat_statements -c pg_stat_statements.track=all -c shared_buffers=1GB -c work_mem=16MB -c effective_io_concurrency=100 -c wal_level=minimal -c archive_mode=off -c max_wal_senders=0
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready", "-U", "postgres" ]
      interval: '10s'
      timeout: '30s'
      retries: 5
      start_period: '20s'
    ports:
      - 5433:5432

  cache-api-integration:
    restart: 'always'
    image: 'redis:latest'
    ports:
      - 6379:6379

  db-functional-ui:
    restart: 'always'
    image: 'postgres:17'
    env_file:
      - ./.env.db
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready", "-U", "postgres" ]
      interval: '10s'
      timeout: '30s'
      retries: 5
      start_period: '20s'
    ports:
      - "5434:5432"

  login-api-mock:
    container_name: login-api-mock
    build:
      context: ../apps/login/integration/api-mock
      additional_contexts:
        zitadel-protos: ../proto
    develop:
      watch:
        - path: ../apps/login/integration/api-mock
          action: "rebuild"
        - path: ../protos
          action: "rebuild"
    ports:
      - 22220:22220
      - 22222:22222

volumes:
  db-data-dev:
