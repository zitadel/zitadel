<cnsl-detail-layout [backRouterLink]="[ serviceType === PolicyComponentServiceType.ADMIN ? '/system' : '/org']"
  [title]="'POLICY.LOGIN_POLICY.TITLE' | translate"
  [description]="(serviceType === PolicyComponentServiceType.MGMT ? 'POLICY.LOGIN_POLICY.DESCRIPTIONCREATEMGMT' : PolicyComponentServiceType.ADMIN ? 'POLICY.LOGIN_POLICY.DESCRIPTIONCREATEADMIN' : '') | translate">
  <p class="policy-applied-to" sub>{{'POLICY.APPLIEDTO' | translate}}:
    <strong *ngIf="orgName; else iam">{{orgName}}</strong>
    <ng-template #iam><strong>{{'MENU.SYSTEM' | translate}}</strong>
    </ng-template>
  </p>

  <cnsl-info-section *ngIf="isDefault"> {{'POLICY.DEFAULTLABEL' | translate}}</cnsl-info-section>

  <div class="spinner-wr">
    <mat-spinner diameter="30" *ngIf="loading" color="primary"></mat-spinner>
  </div>

  <ng-container *ngIf="serviceType === PolicyComponentServiceType.MGMT">
    <ng-template cnslHasRole [hasRole]="['policy.delete']">
      <button *ngIf="!isDefault" color="primary" matTooltip="{{'POLICY.RESET' | translate}}" color="warn"
        (click)="removePolicy()" mat-stroked-button>
        {{'POLICY.RESET' | translate}}
      </button>
    </ng-template>

    <ng-template cnslHasRole [hasRole]="['policy.write']">
      <button *ngIf="isDefault" color="primary" matTooltip="{{'POLICY.CREATECUSTOM' | translate}}"
        (click)="savePolicy()" mat-raised-button>
        {{'POLICY.CREATECUSTOM' | translate}}
      </button>
    </ng-template>
  </ng-container>

  <ng-template cnslHasRole [hasRole]="['org.idp.read']">
    <cnsl-card title="{{ 'IDP.LIST.TITLE' | translate }}" description="{{ 'IDP.LIST.DESCRIPTION' | translate }}">

      <cnsl-info-section
        *ngIf="serviceType === PolicyComponentServiceType.MGMT && (['login_policy.idp'] | hasFeature | async) === false"
        [featureLink]="['/org/features']" class="info" [type]="InfoSectionType.WARN">
        <span [innerHTML]="'FEATURES.NOTAVAILABLE' | translate: ({value: 'login_policy.idp'})"></span>
      </cnsl-info-section>

      <cnsl-idp-table [service]="service" [serviceType]="serviceType"
        [disabled]="([serviceType === PolicyComponentServiceType.ADMIN ? 'iam.idp.write' : serviceType === PolicyComponentServiceType.MGMT ? 'org.idp.write' : ''] | hasRole | async) === false || ((serviceType === PolicyComponentServiceType.MGMT && (['login_policy.idp'] | hasFeature | async) === false))">
      </cnsl-idp-table>
    </cnsl-card>
  </ng-template>

  <cnsl-card title="{{ 'MFA.LIST.MULTIFACTORTITLE' | translate }}"
    description="{{'MFA.LIST.MULTIFACTORDESCRIPTION' | translate}}" [expanded]="true">
    <div class="login-policy-row">
      <cnsl-form-field class="passwordless-allowed" label="Access Code" required="true">
        <cnsl-label>{{'LOGINPOLICY.PASSWORDLESS' | translate}}</cnsl-label>
        <mat-select [(ngModel)]="loginData.passwordlessType"
          [disabled]="disabled || (serviceType === PolicyComponentServiceType.MGMT && (['login_policy.passwordless'] | hasFeature | async) === false)">
          <mat-option *ngFor="let pt of passwordlessTypes" [value]="pt">
            {{'LOGINPOLICY.PASSWORDLESSTYPE.'+pt | translate}}
          </mat-option>
        </mat-select>
      </cnsl-form-field>

      <cnsl-info-section
        *ngIf="serviceType === PolicyComponentServiceType.MGMT && (['login_policy.passwordless'] | hasFeature | async) === false"
        [featureLink]="['/org/features']" class="info" [type]="InfoSectionType.WARN">
        <span [innerHTML]="'FEATURES.NOTAVAILABLE' | translate: ({value: 'login_policy.passwordless'})"></span>
      </cnsl-info-section>
    </div>

    <cnsl-info-section
      *ngIf="serviceType === PolicyComponentServiceType.MGMT && (['login_policy.factors'] | hasFeature | async) === false"
      [featureLink]="['/org/features']" class="info" [type]="InfoSectionType.WARN">
      <span [innerHTML]="'FEATURES.NOTAVAILABLE' | translate: ({value: 'login_policy.factors'})"></span>
    </cnsl-info-section>

    <cnsl-mfa-table [service]="service" [serviceType]="serviceType"
      [componentType]="LoginMethodComponentType.MultiFactor"
      [disabled]="(loginData.passwordlessType === PasswordlessType.PASSWORDLESS_TYPE_NOT_ALLOWED) || (([serviceType === PolicyComponentServiceType.ADMIN ? 'iam.policy.write' : serviceType === PolicyComponentServiceType.MGMT ? 'policy.write' : ''] | hasRole | async) === false) || (serviceType === PolicyComponentServiceType.MGMT && (['login_policy.factors'] | hasFeature | async) === false)">
    </cnsl-mfa-table>
  </cnsl-card>

  <cnsl-card title="{{ 'MFA.LIST.SECONDFACTORTITLE' | translate }}"
    description="{{'MFA.LIST.SECONDFACTORDESCRIPTION' | translate}}" [expanded]="true">
    <mat-slide-toggle card-actions class="force-mfa-toggle" color="primary"
      [disabled]="disabled || serviceType === PolicyComponentServiceType.MGMT && (['login_policy.factors'] | hasFeature | async) === false"
      ngDefaultControl [(ngModel)]="loginData.forceMfa">
      {{'POLICY.DATA.FORCEMFA' | translate}}
    </mat-slide-toggle>

    <cnsl-info-section
      *ngIf="serviceType === PolicyComponentServiceType.MGMT && (['login_policy.factors'] | hasFeature | async) === false"
      [featureLink]="['/org/features']" class="info" [type]="InfoSectionType.WARN">
      <span [innerHTML]="'FEATURES.NOTAVAILABLE' | translate: ({value: 'login_policy.factors'})"></span>
    </cnsl-info-section>

    <cnsl-mfa-table [service]="service" [serviceType]="serviceType"
      [componentType]="LoginMethodComponentType.SecondFactor"
      [disabled]="([serviceType === PolicyComponentServiceType.ADMIN ? 'iam.policy.write' : serviceType === PolicyComponentServiceType.MGMT ? 'policy.write' : ''] | hasRole | async) === false || (serviceType === PolicyComponentServiceType.MGMT && (['login_policy.factors'] | hasFeature | async) === false)">
    </cnsl-mfa-table>
  </cnsl-card>

  <cnsl-card title="{{ 'POLICY.LOGIN_POLICY.ADVANCED' | translate }}">
    <div class="login-policy-content" *ngIf="loginData">
      <div class="login-policy-row">
        <mat-slide-toggle color="primary" matTooltip="{{'POLICY.DATA.FORCEMFA_DESC' | translate}}"
          [disabled]="disabled || serviceType === PolicyComponentServiceType.MGMT && (['login_policy.username_login'] | hasFeature | async) === false"
          ngDefaultControl [(ngModel)]="loginData.allowUsernamePassword">
          {{'POLICY.DATA.ALLOWUSERNAMEPASSWORD' | translate}}
        </mat-slide-toggle>

        <cnsl-info-section
          *ngIf="serviceType === PolicyComponentServiceType.MGMT && (['login_policy.username_login'] | hasFeature | async) === false; else usernameInfo"
          [featureLink]="['/org/features']" class="info" [type]="InfoSectionType.WARN">
          <span [innerHTML]="'FEATURES.NOTAVAILABLE' | translate: ({value: 'login_policy.username_login'})"></span>
        </cnsl-info-section>

        <ng-template #usernameInfo>
          <cnsl-info-section class="info">
            {{'POLICY.DATA.ALLOWUSERNAMEPASSWORD_DESC' | translate}}
          </cnsl-info-section>
        </ng-template>
      </div>
      <div class="login-policy-row">
        <mat-slide-toggle class="login-policy-toggle" color="primary"
          [disabled]="disabled || (serviceType === PolicyComponentServiceType.MGMT && (['login_policy.registration'] | hasFeature | async) === false)"
          ngDefaultControl [(ngModel)]="loginData.allowRegister">
          {{'POLICY.DATA.ALLOWREGISTER' | translate}}
        </mat-slide-toggle>

        <cnsl-info-section
          *ngIf="serviceType === PolicyComponentServiceType.MGMT && (['login_policy.registration'] | hasFeature | async) === false; else regInfo"
          [featureLink]="['/org/features']" class="info" [type]="InfoSectionType.WARN">
          <span [innerHTML]="'FEATURES.NOTAVAILABLE' | translate: ({value: 'login_policy.registration'})"></span>
        </cnsl-info-section>

        <ng-template #regInfo>
          <cnsl-info-section class="info">
            {{'POLICY.DATA.ALLOWREGISTER_DESC' | translate}}
          </cnsl-info-section>
        </ng-template>
      </div>
      <div class="login-policy-row">
        <mat-slide-toggle class="login-policy-toggle" color="primary"
          [disabled]="disabled || serviceType === PolicyComponentServiceType.MGMT && (['login_policy.idp'] | hasFeature | async) === false"
          ngDefaultControl [(ngModel)]="loginData.allowExternalIdp">
          {{'POLICY.DATA.ALLOWEXTERNALIDP' | translate}}
        </mat-slide-toggle>

        <cnsl-info-section
          *ngIf="serviceType === PolicyComponentServiceType.MGMT && (['login_policy.idp'] | hasFeature | async) === false; else idpInfo"
          [featureLink]="['/org/features']" class="info" [type]="InfoSectionType.WARN">
          <span [innerHTML]="'FEATURES.NOTAVAILABLE' | translate: ({value: 'login_policy.idp'})"></span>
        </cnsl-info-section>

        <ng-template #idpInfo>
          <cnsl-info-section class="info">
            {{'POLICY.DATA.ALLOWEXTERNALIDP_DESC' | translate}}
          </cnsl-info-section>
        </ng-template>
      </div>

      <div class="login-policy-row">
        <mat-slide-toggle class="login-policy-toggle" color="primary"
          [disabled]="disabled || serviceType === PolicyComponentServiceType.MGMT && (['login_policy.password_reset'] | hasFeature | async) === false"
          ngDefaultControl [(ngModel)]="loginData.hidePasswordReset">
          {{'POLICY.DATA.HIDEPASSWORDRESET' | translate}}
        </mat-slide-toggle>

        <cnsl-info-section
          *ngIf="serviceType === PolicyComponentServiceType.MGMT && (['login_policy.password_reset'] | hasFeature | async) === false; else passwordResetInfo"
          [featureLink]="['/org/features']" class="info" [type]="InfoSectionType.WARN">
          <span [innerHTML]="'FEATURES.NOTAVAILABLE' | translate: ({value: 'login_policy.password_reset'})"></span>
        </cnsl-info-section>

        <ng-template #passwordResetInfo>
          <cnsl-info-section class="info">
            {{'POLICY.DATA.HIDEPASSWORDRESET_DESC' | translate}}
          </cnsl-info-section>
        </ng-template>
      </div>
    </div>
  </cnsl-card>

  <div class="login-policy-btn-container">
    <button [disabled]="disabled" class="login-policy-save-button" (click)="savePolicy()" color="primary" type="submit"
      mat-raised-button>{{ 'ACTIONS.SAVE' | translate }}</button>
  </div>

  <cnsl-policy-grid class="grid" [currentPolicy]="currentPolicy" [type]="serviceType" tagForFilter="security">
  </cnsl-policy-grid>
</cnsl-detail-layout>